<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Host WAM - Sampler Clean</title>
  <style>
    body {
      margin: 0;
      padding: 24px;
      background: linear-gradient(135deg, #0b1224, #1e293b);
      color: #e2e8f0;
      font-family: 'Segoe UI', Tahoma, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    h1 {
      color: #60a5fa;
      margin-bottom: 12px;
    }
    .info {
      background: rgba(30, 41, 59, 0.8);
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #334155;
      margin-bottom: 24px;
      max-width: 600px;
      line-height: 1.6;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      background: linear-gradient(135deg, #1e3a8a, #1d4ed8);
      color: white;
      border: 1px solid #1d4ed8;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.15s ease;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 14px rgba(29,78,216,0.5);
    }
    input[type="text"] {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #334155;
      background: #0f172a;
      color: #e2e8f0;
      width: 400px;
    }
    #mount {
      box-shadow: 0 20px 60px rgba(0,0,0,0.7);
      margin-bottom: 20px;
    }
    .status {
      margin-top: 16px;
      padding: 12px 20px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 8px;
      border: 1px solid #1d4ed8;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      color: #cbd5e1;
      max-width: 800px;
    }
    .plugin-controls {
      margin-top: 20px;
      padding: 16px;
      background: rgba(30, 41, 59, 0.8);
      border-radius: 8px;
      border: 1px solid #334155;
    }
    .midi-control {
      margin-top: 16px;
      padding: 16px;
      background: rgba(30, 41, 59, 0.8);
      border-radius: 8px;
      border: 1px solid #334155;
    }
    select {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #334155;
      background: #0f172a;
      color: #e2e8f0;
      min-width: 250px;
      margin: 5px;
    }
  </style>
</head>
<body>
  <h1>üéõÔ∏è Host WAM - Sampler Clean</h1>
  <div class="info">
    <strong>Mode WAM officiel</strong> : Chargement via <code>initializeWamHost()</code> depuis le CDN officiel.
    <br>
    Ce host respecte le standard WAM 2.0 et peut charger n'importe quel plugin WAM compatible.
  </div>
  <div id="mount"></div>
  <div class="status" id="status">Initialisation...</div>

  <div class="midi-control">
    <h3 style="color: #60a5fa; margin-bottom: 12px;">üéπ Contr√¥le MIDI</h3>
    <div style="display:flex; gap:8px; align-items:center; flex-wrap: wrap;">
      <label style="color: #cbd5e1;">Device MIDI:</label>
      <select id="midi-device-select">
        <option value="">Aucun device MIDI d√©tect√©</option>
      </select>
      <button id="btn-refresh-midi">üîÑ Rafra√Æchir</button>
      <label style="margin-left: 16px; color: #cbd5e1;">
        <input type="checkbox" id="midi-enabled" style="margin-right:4px;" />
        Activer MIDI
      </label>
    </div>
    <small style="color: #94a3b8; display: block; margin-top: 8px;">
      Le MIDI est mapp√© sur 16 pads (notes 36-51, C1-D#2). Changez de device pour utiliser un autre contr√¥leur.
    </small>
  </div>

  <div class="plugin-controls">
    <h3 style="color: #60a5fa; margin-bottom: 12px;">Charger un plugin WAM tiers</h3>
    <div style="display:flex; gap:8px; margin-bottom:10px; flex-wrap: wrap;">
      <input id="plugin-url" type="text" placeholder="URL du module WAM (ESM)" />
      <button id="btn-load-plugin">Charger plugin</button>
      <button id="btn-load-known">Charger plugins connus</button>
    </div>
    <small>Le plugin sera ins√©r√© en cha√Æne apr√®s le sampler (sampler ‚Üí plugin ‚Üí sortie).</small>
    <div id="plugins-list" style="margin-top:12px;"></div>
  </div>

  <script type="module">
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const statusEl = document.getElementById('status');
    const pluginsListEl = document.getElementById('plugins-list');
    const loadedPlugins = []; // { name, url, instance, guiEl }

    function setStatus(msg) {
      statusEl.textContent = msg;
      console.log(msg);
    }

    async function main() {
      try {
        setStatus('‚è≥ Initialisation du host WAM...');
        
        // Importer et initialiser le host WAM depuis le CDN
        const { default: initializeWamHost } = await import(
          'https://www.webaudiomodules.com/sdk/2.0.0-alpha.6/src/initializeWamHost.js'
        );
        const [hostGroupId] = await initializeWamHost(audioContext);
        
        setStatus(`‚úì Host WAM initialis√© (groupId: ${hostGroupId})`);

        // Charger le plugin sampler avec le hostGroupId
        setStatus('‚è≥ Chargement du plugin sampler...');
        const { default: SamplerPlugin } = await import('../samplerPlugin/src/index.js');
        const sampler = await SamplerPlugin.createInstance(hostGroupId, audioContext);
        
        setStatus('‚úì Plugin sampler cr√©√©');

        // Connecter √† la sortie audio
        sampler.audioNode.connect(audioContext.destination);
        setStatus('‚úì Audio connect√©');

        // Cr√©er et monter la GUI
        const gui = await sampler.createGui();
        document.getElementById('mount').appendChild(gui);
        
        setStatus('‚úì Sampler pr√™t ! Chargez des samples avec le bouton üìÅ ou drag & drop.');

        console.log('Plugin sampler:', sampler);
        console.log('Audio node:', sampler.audioNode);

        // Gestion du chargement de plugins WAM tiers
        const urlInput = document.getElementById('plugin-url');
        const btnLoad = document.getElementById('btn-load-plugin');
        const btnKnown = document.getElementById('btn-load-known');

        async function loadWam(url) {
          try {
            setStatus(`‚è≥ Chargement plugin WAM depuis ${url} ...`);
            const { default: WAM } = await import(url);
            const plugin = await WAM.createInstance(hostGroupId, audioContext);
            
            // Cha√Æne : sampler ‚Üí plugin ‚Üí destination
            sampler.audioNode.disconnect();
            sampler.audioNode.connect(plugin.audioNode);
            plugin.audioNode.connect(audioContext.destination);
            
            setStatus('‚úì Plugin WAM charg√© et connect√© apr√®s le sampler');
            console.log('WAM tiers:', plugin);
            // Cr√©er et monter la GUI du plugin
            let gui;
            try {
              gui = await plugin.createGui();
            } catch (e) {
              console.warn('GUI non disponible pour ce plugin:', e);
            }

            const name = (plugin?.descriptor?.name) || (url.split('/').slice(-2, -1)[0]) || 'Plugin';
            const container = document.createElement('div');
            container.style.marginTop = '10px';
            container.style.padding = '10px';
            container.style.border = '1px solid #334155';
            container.style.borderRadius = '8px';
            container.style.background = 'rgba(15, 23, 42, 0.6)';

            const header = document.createElement('div');
            header.style.display = 'flex';
            header.style.alignItems = 'center';
            header.style.justifyContent = 'space-between';
            const title = document.createElement('div');
            title.textContent = `‚öôÔ∏è ${name}`;
            const removeBtn = document.createElement('button');
            removeBtn.textContent = 'Retirer';
            removeBtn.onclick = () => {
              try { plugin.audioNode.disconnect(); } catch {}
              // Reconnecter directement sampler ‚Üí destination ou √† la cha√Æne suivante si plusieurs
              try { sampler.audioNode.disconnect(); } catch {}
              sampler.audioNode.connect(audioContext.destination);
              container.remove();
              const idx = loadedPlugins.findIndex(p => p.instance === plugin);
              if (idx >= 0) loadedPlugins.splice(idx, 1);
              setStatus(`‚úì Plugin retir√©: ${name}`);
            };
            header.appendChild(title);
            header.appendChild(removeBtn);
            container.appendChild(header);

            if (gui) {
              const guiWrap = document.createElement('div');
              guiWrap.style.marginTop = '8px';
              guiWrap.appendChild(gui);
              container.appendChild(guiWrap);
            } else {
              const info = document.createElement('div');
              info.textContent = 'GUI non fournie par ce plugin.';
              info.style.marginTop = '8px';
              container.appendChild(info);
            }

            pluginsListEl.appendChild(container);
            loadedPlugins.push({ name, url, instance: plugin, guiEl: gui });
            return plugin;
          } catch (e) {
            setStatus(`‚úó √âchec chargement plugin : ${e.message}`);
            console.error(e);
            throw e;
          }
        }

        btnLoad.onclick = () => {
          const url = urlInput.value.trim();
          if (url) loadWam(url);
        };

        // Bouton plugins connus : utilise URLs valid√©es de wam-sampler-host.html
        btnKnown.onclick = async () => {
          const knownPlugins = [
            'https://www.webaudiomodules.com/community/plugins/wimmics/greyhole/index.js',
            'https://www.webaudiomodules.com/community/plugins/wimmics/pingpongdelay/dist/index.js'
          ];
          
          for (const url of knownPlugins) {
            try {
              await loadWam(url);
            } catch (e) {
              console.warn('Essai √©chou√© pour', url, e.message);
            }
          }
        };
        
      } catch (err) {
        setStatus(`‚úó Erreur : ${err.message}`);
        console.error('Erreur initialisation host WAM:', err);
      }
    }

    // Reprendre l'audio context au premier clic
    const __wam_resume_handler = () => {
      if (audioContext.state === 'suspended') {
        audioContext.resume();
        setStatus('‚úì Audio context repris');
      }
      try { window.removeEventListener('click', __wam_resume_handler); } catch (e) {}
    };
    window.addEventListener('click', __wam_resume_handler);

    main();
  </script>
</body>
</html>
